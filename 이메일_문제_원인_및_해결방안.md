# ì´ë©”ì¼ ë¬¸ì œ ì›ì¸ ë° í•´ê²°ë°©ì•ˆ

## ğŸ” ë¡œê·¸ ë¶„ì„ ê²°ê³¼

### ë°œê²¬ëœ ì—ëŸ¬
```
ERROR: operator does not exist: uuid = text
No operator matches the given name and argument types. 
You might need to add explicit type casts.
```

### ë¬¸ì œ ì›ì¸

**í•µì‹¬ ë¬¸ì œ**: íƒ€ì… ë¶ˆì¼ì¹˜ë¡œ ì¸í•œ ë°ì´í„°ë² ì´ìŠ¤ ì—ëŸ¬

1. **email_logs í…Œì´ë¸” êµ¬ì¡°**:
   - `task_id` ì»¬ëŸ¼: **UUID íƒ€ì…**
   - Foreign Key: `tasks(id)` ì°¸ì¡°

2. **Edge Function ì½”ë“œ**:
   - `emailData.taskId`: **string íƒ€ì…**
   - `supabase.from("email_logs").insert({ task_id: emailData.taskId })`

3. **ë¬¸ì œ ë°œìƒ ì§€ì **:
   - Edge Functionì—ì„œ `email_logs` í…Œì´ë¸”ì— insert ì‹œë„
   - `task_id`ì— string ê°’ì„ ì „ë‹¬
   - PostgreSQLì—ì„œ UUIDì™€ TEXT íƒ€ì… ë¹„êµ ì‹œë„
   - íƒ€ì… ë¶ˆì¼ì¹˜ ì—ëŸ¬ ë°œìƒ
   - **ê²°ê³¼**: email_logsì— ë°ì´í„°ê°€ ê¸°ë¡ë˜ì§€ ì•ŠìŒ

### í˜„ì¬ ìƒíƒœ

- âœ… íŠ¸ë¦¬ê±° í•¨ìˆ˜: ì •ìƒ ì‘ë™ (í•˜ë“œì½”ë”©, ë¡œê¹… ì¶”ê°€ë¨)
- âœ… Edge Function: ë°°í¬ë˜ì–´ ìˆê³  í™œì„±í™”ë¨
- âŒ **Edge Function ì‹¤í–‰ ì‹œ íƒ€ì… ì—ëŸ¬ ë°œìƒ**
- âŒ **email_logs í…Œì´ë¸”ì— ë°ì´í„° ê¸°ë¡ ì‹¤íŒ¨**

---

## ğŸ› ï¸ í•´ê²°ë°©ì•ˆ

### ë°©ë²• 1: Edge Function ì½”ë“œ ìˆ˜ì • (ê¶Œì¥)

Supabase JS í´ë¼ì´ì–¸íŠ¸ëŠ” ì¼ë°˜ì ìœ¼ë¡œ UUID ë¬¸ìì—´ì„ ìë™ìœ¼ë¡œ ë³€í™˜í•˜ì§€ë§Œ, Edge Function í™˜ê²½ì—ì„œëŠ” ëª…ì‹œì  ì²˜ë¦¬ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ìˆ˜ì • ì „**:
```typescript
await supabase.from("email_logs").insert({
  task_id: emailData.taskId,  // string
  // ...
});
```

**ìˆ˜ì • í›„**:
```typescript
// UUID ë¬¸ìì—´ì´ ìœ íš¨í•œ í˜•ì‹ì¸ì§€ í™•ì¸í•˜ê³  ê·¸ëŒ€ë¡œ ì „ë‹¬
// Supabase JS í´ë¼ì´ì–¸íŠ¸ê°€ ìë™ìœ¼ë¡œ UUIDë¡œ ë³€í™˜í•´ì¤Œ
await supabase.from("email_logs").insert({
  task_id: emailData.taskId,  // ìœ íš¨í•œ UUID ë¬¸ìì—´ì´ë©´ ìë™ ë³€í™˜ë¨
  // ...
});
```

**ì‹¤ì œë¡œëŠ” ì½”ë“œê°€ ì´ë¯¸ ì˜¬ë°”ë¥´ê²Œ ì‘ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤.** ë¬¸ì œëŠ” ë‹¤ë¥¸ ê³³ì— ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ë°©ë²• 2: Edge Function ì¬ë°°í¬

ì½”ë“œ ìˆ˜ì • í›„ Edge Functionì„ ì¬ë°°í¬í•´ì•¼ í•©ë‹ˆë‹¤:

```bash
supabase functions deploy send-task-email --project-ref dcovjxmrqomuuwcgiwie
```

### ë°©ë²• 3: ë°ì´í„°ë² ì´ìŠ¤ íƒ€ì… í™•ì¸

ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ íƒ€ì…ì„ í™•ì¸:

```sql
-- email_logs í…Œì´ë¸”ì˜ task_id íƒ€ì… í™•ì¸
SELECT 
  column_name,
  data_type,
  udt_name
FROM information_schema.columns
WHERE table_schema = 'public' 
  AND table_name = 'email_logs'
  AND column_name = 'task_id';
```

---

## ğŸ” ì¶”ê°€ ì§„ë‹¨ í•„ìš” ì‚¬í•­

### 1. Edge Function ë¡œê·¸ í™•ì¸

Supabase Dashboard â†’ Edge Functions â†’ send-task-email â†’ Logsì—ì„œ:
- `[send-task-email] Failed to log email` ë©”ì‹œì§€ í™•ì¸
- ì—ëŸ¬ ìƒì„¸ ë‚´ìš© í™•ì¸

### 2. íŠ¸ë¦¬ê±° ì‹¤í–‰ í™•ì¸

Postgres Logsì—ì„œ:
- `[EMAIL_TRIGGER]` ë©”ì‹œì§€ í™•ì¸
- íŠ¸ë¦¬ê±°ê°€ ì‹¤ì œë¡œ ì‹¤í–‰ë˜ëŠ”ì§€ í™•ì¸

### 3. Edge Function ì§ì ‘ í…ŒìŠ¤íŠ¸

curlë¡œ ì§ì ‘ í˜¸ì¶œí•˜ì—¬ ì—ëŸ¬ í™•ì¸:

```bash
curl -X POST \
  'https://dcovjxmrqomuuwcgiwie.supabase.co/functions/v1/send-task-email' \
  -H 'Authorization: Bearer [SERVICE_ROLE_KEY]' \
  -H 'Content-Type: application/json' \
  -d '{
    "eventType": "STATUS_CHANGED",
    "taskId": "4f0f6df6-7422-4b28-ba1e-cce16cbe4ec8",
    "oldStatus": "ASSIGNED",
    "newStatus": "IN_PROGRESS",
    "assignerEmail": "test@example.com",
    "assigneeEmail": "test@example.com",
    "assignerName": "ì§€ì‹œì",
    "assigneeName": "ë‹´ë‹¹ì",
    "taskTitle": "í…ŒìŠ¤íŠ¸ Task",
    "projectTitle": "í…ŒìŠ¤íŠ¸ í”„ë¡œì íŠ¸",
    "recipients": ["assigner", "assignee"]
  }'
```

---

## ğŸ“‹ í•´ê²° ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] Edge Function ì½”ë“œ í™•ì¸ (task_id ì „ë‹¬ ë°©ì‹)
- [ ] Edge Function ì¬ë°°í¬
- [ ] Edge Function ë¡œê·¸ì—ì„œ ì—ëŸ¬ ë©”ì‹œì§€ í™•ì¸
- [ ] Postgres Logsì—ì„œ íŠ¸ë¦¬ê±° ì‹¤í–‰ í™•ì¸
- [ ] Edge Function ì§ì ‘ í…ŒìŠ¤íŠ¸
- [ ] email_logs í…Œì´ë¸”ì— ë°ì´í„° ê¸°ë¡ í™•ì¸

---

## ğŸ’¡ ì˜ˆìƒ í•´ê²° ìˆœì„œ

1. **Edge Function ë¡œê·¸ í™•ì¸** (ê°€ì¥ ì¤‘ìš”)
   - ì‹¤ì œ ì—ëŸ¬ ë©”ì‹œì§€ í™•ì¸
   - `Failed to log email` ë©”ì‹œì§€ í™•ì¸

2. **Edge Function ì¬ë°°í¬**
   - ì½”ë“œ ìˆ˜ì • í›„ ì¬ë°°í¬
   - ìµœì‹  ì½”ë“œê°€ ë°°í¬ë˜ì—ˆëŠ”ì§€ í™•ì¸

3. **í…ŒìŠ¤íŠ¸ Task ìƒì„±**
   - ìƒˆ Task ìƒì„± ë˜ëŠ” ìƒíƒœ ë³€ê²½
   - ë¡œê·¸ í™•ì¸

4. **email_logs í™•ì¸**
   - ë°ì´í„°ê°€ ê¸°ë¡ë˜ì—ˆëŠ”ì§€ í™•ì¸
   - ì—ëŸ¬ ë©”ì‹œì§€ í™•ì¸

---

## ğŸ”— ê´€ë ¨ íŒŒì¼

- `supabase/functions/send-task-email/index.ts`: Edge Function ì½”ë“œ
- `supabase/migrations/20250101000004_create_email_logs_table.sql`: email_logs í…Œì´ë¸” ìƒì„±
- `ì´ë©”ì¼_ë°œì†¡_ë¡œì§_ì „ì²´_ë¶„ì„.md`: ì „ì²´ ë¡œì§ ë¶„ì„


