# Task ê¶Œí•œ ìš”êµ¬ì‚¬í•­ êµ¬í˜„ ì™„ë£Œ ìš”ì•½

## ğŸ“‹ êµ¬í˜„ ë‚´ìš©

### 1. RLS ì •ì±… ìˆ˜ì •

**ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼:** `supabase/migrations/20260110000013_update_task_select_policy_participants_all_tasks.sql`

#### ë³€ê²½ ì‚¬í•­:
- **Task SELECT ì •ì±…**: `tasks_select_assigner_assignee_or_admin` â†’ `tasks_select_participant_or_admin`
  - í”„ë¡œì íŠ¸ ì°¸ì—¬ì ì „ì›ì´ ëª¨ë“  Task ëª©ë¡ ì¡°íšŒ ê°€ëŠ¥
  - ì´ì „: assigner/assigneeë§Œ ì ‘ê·¼ ê°€ëŠ¥
  - í˜„ì¬: í”„ë¡œì íŠ¸ ì°¸ì—¬ì ì „ì› ì ‘ê·¼ ê°€ëŠ¥

- **Messages SELECT ì •ì±…**: `messages_select_assigner_assignee_or_admin` â†’ `messages_select_participant_or_admin`
  - Task SELECT ì •ì±…ê³¼ ì¼ì¹˜í•˜ë„ë¡ ìˆ˜ì •
  - í”„ë¡œì íŠ¸ ì°¸ì—¬ì ì „ì›ì´ ë©”ì‹œì§€ ì¡°íšŒ ê°€ëŠ¥

#### RLS ì •ì±… ì½”ë“œ:
```sql
CREATE POLICY "tasks_select_participant_or_admin"
ON public.tasks
FOR SELECT
USING (
  is_admin((SELECT auth.uid()))
  OR is_project_participant((SELECT auth.uid()), project_id)
);
```

### 2. API í•¨ìˆ˜ ìˆ˜ì •

**íŒŒì¼:** `src/api/task.ts`

#### `getTaskById()` í•¨ìˆ˜ ìˆ˜ì •:
- ê¶Œí•œë³„ ì ‘ê·¼ ì œì–´ ë¡œì§ ì¶”ê°€
- Admin: ëª¨ë“  Task ìƒì„¸ ì ‘ê·¼ ê°€ëŠ¥
- Member (assigner/assignee): ìì‹ ì˜ Task ìƒì„¸ ì ‘ê·¼ ê°€ëŠ¥
- Member (ê¸°íƒ€): ì œí•œëœ ì •ë³´ë§Œ ë°˜í™˜ (description ë§ˆìŠ¤í‚¹)

#### êµ¬í˜„ ë¡œì§:
```typescript
// Admin ê¶Œí•œ í™•ì¸
const isAdmin = profile?.role === "admin";
const isAssigner = data.assigner_id === userId;
const isAssignee = data.assignee_id === userId;

// ê¶Œí•œ ê²€ì¦ ë° í•„ë“œ ì œì–´
if (!isAdmin && !isAssigner && !isAssignee) {
  // ì¼ë°˜ ë©¤ë²„ê°€ ìì‹ ì˜ Taskê°€ ì•„ë‹Œ ê²½ìš°: ì œí•œëœ ì •ë³´ë§Œ ë°˜í™˜
  return {
    ...data,
    description: null, // ìƒì„¸ ë‚´ìš© ë§ˆìŠ¤í‚¹
  } as TaskWithProfiles;
}

// Admin ë˜ëŠ” assigner/assignee: ëª¨ë“  í•„ë“œ ë°˜í™˜
return data as TaskWithProfiles;
```

---

## âœ… ìµœì¢… ê¶Œí•œ êµ¬ì¡°

### Task ëª©ë¡ ì¡°íšŒ
- **í”„ë¡œì íŠ¸ ì°¸ì—¬ì ì „ì›** (admin + member): ëª¨ë“  Task ëª©ë¡ ì¡°íšŒ ê°€ëŠ¥
- RLS ì •ì±…ìœ¼ë¡œ ì œì–´ë¨

### Task ìƒì„¸ ì ‘ê·¼
- **ê´€ë¦¬ì(admin)**: ëª¨ë“  Task ìƒì„¸ ì ‘ê·¼ ê°€ëŠ¥
- **ì¼ë°˜ ë©¤ë²„(member)**:
  - ë³¸ì¸ì´ assigner ë˜ëŠ” assigneeì¸ Task: ëª¨ë“  í•„ë“œ ì ‘ê·¼ ê°€ëŠ¥
  - ìì‹ ì˜ Taskê°€ ì•„ë‹Œ ê²½ìš°: ì œí•œëœ ì •ë³´ë§Œ ì ‘ê·¼ ê°€ëŠ¥ (description ë§ˆìŠ¤í‚¹)
- ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì—ì„œ ì œì–´ë¨

---

## ğŸ”„ ë³€ê²½ ì „í›„ ë¹„êµ

### ë³€ê²½ ì „
- **ëª©ë¡ ì¡°íšŒ**: ê´€ë¦¬ìëŠ” ëª¨ë“  Task, ë©¤ë²„ëŠ” ìì‹ ì´ í¬í•¨ëœ Taskë§Œ
- **ìƒì„¸ ì ‘ê·¼**: êµ¬ë¶„ ì—†ìŒ (RLSë¡œë§Œ ì œì–´)

### ë³€ê²½ í›„
- **ëª©ë¡ ì¡°íšŒ**: í”„ë¡œì íŠ¸ ì°¸ì—¬ì ì „ì›ì´ ëª¨ë“  Task ì¡°íšŒ ê°€ëŠ¥ âœ…
- **ìƒì„¸ ì ‘ê·¼**: ê¶Œí•œë³„ êµ¬ë¶„ (ê´€ë¦¬ì: ëª¨ë“  Task, ë©¤ë²„: ìì‹ ì˜ Taskë§Œ) âœ…

---

## ğŸ¯ Task ëª©ë¡ í•„í„°ì™€ì˜ ì—°ë™

ì´ì œ Task ëª©ë¡ í•„í„°ê°€ ì •í™•í•˜ê²Œ ì‘ë™í•©ë‹ˆë‹¤:
- í”„ë¡œì íŠ¸ ì°¸ì—¬ì ì „ì›ì´ ëª¨ë“  Taskë¥¼ ë³¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ
- í•„í„° ê¸°ëŠ¥ (ì—­í•  í•„í„°, ìƒíƒœ í•„í„°, ê²€ìƒ‰)ì´ ëª¨ë“  Taskì— ëŒ€í•´ ì •ìƒ ì‘ë™
- ë©¤ë²„ë„ í”„ë¡œì íŠ¸ ì „ì²´ ìƒí™©ì„ íŒŒì•…í•  ìˆ˜ ìˆìŒ

---

## ğŸ“ ë‹¤ìŒ ë‹¨ê³„

1. **ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš©**: `supabase/migrations/20260110000013_update_task_select_policy_participants_all_tasks.sql` ì‹¤í–‰
2. **í…ŒìŠ¤íŠ¸**:
   - í”„ë¡œì íŠ¸ ì°¸ì—¬ì ì „ì›ì´ Task ëª©ë¡ ì¡°íšŒ ê°€ëŠ¥ í™•ì¸
   - ê´€ë¦¬ìê°€ ëª¨ë“  Task ìƒì„¸ ì ‘ê·¼ ê°€ëŠ¥ í™•ì¸
   - ë©¤ë²„ê°€ ìì‹ ì˜ Task ìƒì„¸ ì ‘ê·¼ ê°€ëŠ¥ í™•ì¸
   - ë©¤ë²„ê°€ ë‹¤ë¥¸ ì‚¬ëŒì˜ Task ìƒì„¸ ì ‘ê·¼ ì‹œ ì œí•œ í™•ì¸
3. **UI í™•ì¸**: Task ëª©ë¡ í•„í„°ê°€ ì •ìƒ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸

---

## ğŸ” ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

1. **RLS ì •ì±…**: í–‰(row) ë‹¨ìœ„ ì ‘ê·¼ ì œì–´
   - í”„ë¡œì íŠ¸ ì°¸ì—¬ì ì „ì›ì´ Task ëª©ë¡ ì¡°íšŒ ê°€ëŠ¥
   - í”„ë¡œì íŠ¸ ì°¸ì—¬ìê°€ ì•„ë‹Œ ì‚¬ìš©ìëŠ” ì ‘ê·¼ ë¶ˆê°€

2. **ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨**: ì»¬ëŸ¼ ë‹¨ìœ„ ì ‘ê·¼ ì œì–´
   - ìƒì„¸ ì ‘ê·¼ ê¶Œí•œë³„ ì œì–´
   - description í•„ë“œ ë§ˆìŠ¤í‚¹ìœ¼ë¡œ ë¯¼ê° ì •ë³´ ë³´í˜¸

3. **ì´ì¤‘ ë³´ì•ˆ êµ¬ì¡°**:
   - RLS: ê¸°ë³¸ ì ‘ê·¼ ê¶Œí•œ ì œì–´
   - ì• í”Œë¦¬ì¼€ì´ì…˜: ì„¸ë°€í•œ ì ‘ê·¼ ê¶Œí•œ ì œì–´

---

## âœ… ì™„ë£Œ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] RLS ì •ì±… ìˆ˜ì • (tasks_select_participant_or_admin)
- [x] Messages RLS ì •ì±… ìˆ˜ì • (Task SELECTì™€ ì¼ì¹˜)
- [x] getTaskById() API í•¨ìˆ˜ì— ê¶Œí•œ ê²€ì¦ ë¡œì§ ì¶”ê°€
- [x] ì œí•œëœ Task ì •ë³´ ë°˜í™˜ ë¡œì§ êµ¬í˜„ (description ë§ˆìŠ¤í‚¹)
- [x] ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ìƒì„±
- [x] ì½”ë“œ ë¦°íŠ¸ ê²€ì¦ ì™„ë£Œ

---

## ğŸ“Œ ì°¸ê³ ì‚¬í•­

- Messages INSERT ì •ì±…ì€ ê·¸ëŒ€ë¡œ ìœ ì§€ë¨ (ì§€ì‹œì ë˜ëŠ” ë‹´ë‹¹ìë§Œ ë©”ì‹œì§€ ì‘ì„± ê°€ëŠ¥)
- Task ìƒì„±/ìˆ˜ì •/ì‚­ì œ ê¶Œí•œì€ ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€ë¨
- í”„ë¡œì íŠ¸ ì°¸ì—¬ì ê´€ë¦¬ ê¶Œí•œì€ ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€ë¨ (Adminë§Œ ê°€ëŠ¥)

