# ì´ë©”ì¼ ë°œì†¡ ë¡œì§ ì „ì²´ ë¶„ì„

## ğŸ“‹ ì´ë©”ì¼ ë°œì†¡ íë¦„ë„

```
[1] Task ìƒì„±/ìƒíƒœ ë³€ê²½
    â†“
[2] ë°ì´í„°ë² ì´ìŠ¤ íŠ¸ë¦¬ê±° ì‹¤í–‰
    â”œâ”€ trigger_send_task_created_email (Task ìƒì„± ì‹œ)
    â””â”€ trigger_send_task_status_change_email (Task ìƒíƒœ ë³€ê²½ ì‹œ)
    â†“
[3] íŠ¸ë¦¬ê±° í•¨ìˆ˜ ì‹¤í–‰
    â”œâ”€ send_task_created_email()
    â””â”€ send_task_status_change_email()
    â†“
[4] net.http_postë¡œ Edge Function í˜¸ì¶œ
    â”œâ”€ URL: https://dcovjxmrqomuuwcgiwie.supabase.co/functions/v1/send-task-email
    â”œâ”€ Method: POST
    â”œâ”€ Headers: Authorization (Bearer Service Role Key)
    â””â”€ Body: JSON (ì´ë©”ì¼ ë°ì´í„°)
    â†“
[5] Edge Function ì‹¤í–‰ (send-task-email)
    â”œâ”€ ìš”ì²­ ë³¸ë¬¸ íŒŒì‹± ë° ê²€ì¦
    â”œâ”€ SMTP ì„¤ì • í™•ì¸ (SMTP_USER, SMTP_PASS)
    â”œâ”€ Supabase í´ë¼ì´ì–¸íŠ¸ ìƒì„± (SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY)
    â”œâ”€ ì´ë©”ì¼ í…œí”Œë¦¿ ìƒì„±
    â”œâ”€ nodemailerë¡œ ì´ë©”ì¼ ë°œì†¡
    â””â”€ email_logs í…Œì´ë¸”ì— ê¸°ë¡
    â†“
[6] email_logs í…Œì´ë¸”ì— ë¡œê·¸ ì €ì¥
    â”œâ”€ status: 'sent' ë˜ëŠ” 'failed'
    â”œâ”€ error_message: ì—ëŸ¬ ë°œìƒ ì‹œ ë©”ì‹œì§€
    â””â”€ sent_at: ë°œì†¡ ì™„ë£Œ ì‹œê°„
```

---

## ğŸ” ê° ë‹¨ê³„ë³„ ìƒì„¸ ë¶„ì„

### 1ë‹¨ê³„: Task ìƒì„±/ìƒíƒœ ë³€ê²½

**íŠ¸ë¦¬ê±° ì¡°ê±´**:
- **Task ìƒì„±**: `AFTER INSERT ON public.tasks`
- **Task ìƒíƒœ ë³€ê²½**: `AFTER UPDATE OF task_status ON public.tasks`

**íŠ¸ë¦¬ê±° ì´ë¦„**:
- `trigger_send_task_created_email`
- `trigger_send_task_status_change_email`

**í™•ì¸ ë°©ë²•**:
```sql
SELECT 
  tgname AS trigger_name,
  CASE 
    WHEN tgenabled = 'O' THEN 'í™œì„±í™”ë¨'
    ELSE 'ë¹„í™œì„±í™”ë¨'
  END AS status
FROM pg_trigger
WHERE tgname IN ('trigger_send_task_created_email', 'trigger_send_task_status_change_email');
```

---

### 2ë‹¨ê³„: íŠ¸ë¦¬ê±° í•¨ìˆ˜ ì‹¤í–‰

#### 2.1 send_task_created_email() í•¨ìˆ˜

**ìœ„ì¹˜**: `supabase/migrations/20250101000028_fix_email_triggers_final.sql`

**ì£¼ìš” ë¡œì§**:
1. assignerì™€ assigneeì˜ ì´ë©”ì¼ ë° ì´ë¦„ ì¡°íšŒ
2. í”„ë¡œì íŠ¸ ì œëª© ì¡°íšŒ
3. Edge Function ìš”ì²­ ë³¸ë¬¸ ìƒì„± (JSONB)
4. `net.http_post`ë¡œ Edge Function í˜¸ì¶œ

**ìš”ì²­ ë³¸ë¬¸ êµ¬ì¡°**:
```json
{
  "eventType": "TASK_CREATED",
  "taskId": "task-uuid",
  "assignerEmail": "assigner@example.com",
  "assigneeEmail": "assignee@example.com",
  "assignerName": "í• ë‹¹ì ì´ë¦„",
  "assigneeName": "ë‹´ë‹¹ì ì´ë¦„",
  "taskTitle": "Task ì œëª©",
  "taskDescription": "Task ì„¤ëª…",
  "projectTitle": "í”„ë¡œì íŠ¸ ì œëª©",
  "projectId": "project-uuid",
  "dueDate": "2025-01-01",
  "recipients": ["assigner", "assignee"]
}
```

**ë¡œê¹…**:
- `RAISE NOTICE '[EMAIL_TRIGGER] Task created: [task_id]'`
- `RAISE NOTICE '[EMAIL_TRIGGER] Calling Edge Function: [url]'`
- `RAISE NOTICE '[EMAIL_TRIGGER] HTTP request submitted with ID: [id]'`

#### 2.2 send_task_status_change_email() í•¨ìˆ˜

**ìœ„ì¹˜**: `supabase/migrations/20250101000028_fix_email_triggers_final.sql`

**íŠ¸ë¦¬ê±° ì¡°ê±´**:
- `ASSIGNED` â†’ `IN_PROGRESS`
- `IN_PROGRESS` â†’ `WAITING_CONFIRM`
- `WAITING_CONFIRM` â†’ `APPROVED` ë˜ëŠ” `REJECTED`
- `REJECTED` â†’ `IN_PROGRESS`

**ì£¼ìš” ë¡œì§**:
1. ìƒíƒœ ë³€ê²½ í™•ì¸
2. assignerì™€ assigneeì˜ ì´ë©”ì¼ ë° ì´ë¦„ ì¡°íšŒ
3. ë³€ê²½ì(changer) ì •ë³´ ì¡°íšŒ
4. ìˆ˜ì‹ ì ê²°ì • (ìƒíƒœ ì „í™˜ì— ë”°ë¼ ë‹¤ë¦„)
5. Edge Function ìš”ì²­ ë³¸ë¬¸ ìƒì„±
6. `net.http_post`ë¡œ Edge Function í˜¸ì¶œ

**ìš”ì²­ ë³¸ë¬¸ êµ¬ì¡°**:
```json
{
  "eventType": "STATUS_CHANGED",
  "taskId": "task-uuid",
  "oldStatus": "ASSIGNED",
  "newStatus": "IN_PROGRESS",
  "assignerEmail": "assigner@example.com",
  "assigneeEmail": "assignee@example.com",
  "assignerName": "í• ë‹¹ì ì´ë¦„",
  "assigneeName": "ë‹´ë‹¹ì ì´ë¦„",
  "changerId": "changer-uuid",
  "changerName": "ë³€ê²½ì ì´ë¦„",
  "taskTitle": "Task ì œëª©",
  "taskDescription": "Task ì„¤ëª…",
  "projectTitle": "í”„ë¡œì íŠ¸ ì œëª©",
  "projectId": "project-uuid",
  "dueDate": "2025-01-01",
  "recipients": ["assigner", "assignee"]
}
```

**ìˆ˜ì‹ ì ê²°ì • ë¡œì§**:
- `ASSIGNED` â†’ `IN_PROGRESS`: `["assigner", "assignee"]`
- `IN_PROGRESS` â†’ `WAITING_CONFIRM`: `["assigner"]`
- `WAITING_CONFIRM` â†’ `APPROVED/REJECTED`: `["assignee"]`
- `REJECTED` â†’ `IN_PROGRESS`: `["assigner"]`

**ë¡œê¹…**:
- `RAISE NOTICE '[EMAIL_TRIGGER] Status changed: [old] -> [new] (task: [id])'`
- `RAISE NOTICE '[EMAIL_TRIGGER] Recipients: [array]'`
- `RAISE NOTICE '[EMAIL_TRIGGER] Calling Edge Function: [url]'`
- `RAISE NOTICE '[EMAIL_TRIGGER] HTTP request submitted with ID: [id]'`

---

### 3ë‹¨ê³„: net.http_postë¡œ Edge Function í˜¸ì¶œ

**í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜**:
```sql
net.http_post(
  url text,
  body jsonb,
  params jsonb,
  headers jsonb
) RETURNS bigint
```

**í˜¸ì¶œ ì˜ˆì‹œ**:
```sql
SELECT net.http_post(
  url := 'https://dcovjxmrqomuuwcgiwie.supabase.co/functions/v1/send-task-email',
  body := request_body,
  params := '{}'::jsonb,
  headers := jsonb_build_object(
    'Content-Type', 'application/json',
    'Authorization', 'Bearer [SERVICE_ROLE_KEY]'
  )
) INTO http_response_id;
```

**íŠ¹ì§•**:
- ë¹„ë™ê¸° í˜¸ì¶œ (non-blocking)
- HTTP ìš”ì²­ ID ë°˜í™˜
- íŠ¸ë¦¬ê±° í•¨ìˆ˜ëŠ” HTTP ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ì§€ ì•ŠìŒ

**í™•ì¸ ë°©ë²•**:
- Postgres Logsì—ì„œ `[EMAIL_TRIGGER]` ë©”ì‹œì§€ í™•ì¸
- HTTP ìš”ì²­ ID í™•ì¸

---

### 4ë‹¨ê³„: Edge Function ì‹¤í–‰

**ìœ„ì¹˜**: `supabase/functions/send-task-email/index.ts`

**ì£¼ìš” ë¡œì§**:

#### 4.1 ìš”ì²­ ì²˜ë¦¬
```typescript
// 1. CORS ì²˜ë¦¬
if (req.method === "OPTIONS") { ... }

// 2. ìš”ì²­ ë³¸ë¬¸ íŒŒì‹±
const emailData: EmailRequest = await req.json();

// 3. í•„ìˆ˜ í•„ë“œ ê²€ì¦
if (!emailData.taskId || !emailData.eventType || ...) {
  return new Response(JSON.stringify({ error: "Missing required fields" }), { status: 400 });
}
```

#### 4.2 SMTP ì„¤ì • í™•ì¸
```typescript
const smtpUser = Deno.env.get("SMTP_USER");
const smtpPass = Deno.env.get("SMTP_PASS");

if (!smtpUser || !smtpPass) {
  return new Response(JSON.stringify({ error: "SMTP credentials not configured" }), { status: 500 });
}
```

#### 4.3 Supabase í´ë¼ì´ì–¸íŠ¸ ìƒì„±
```typescript
const supabaseUrl = Deno.env.get("SUPABASE_URL");
const supabaseServiceKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY");

const supabase = createClient(supabaseUrl, supabaseServiceKey);
```

#### 4.4 ì´ë©”ì¼ ë°œì†¡
```typescript
// 1. ìˆ˜ì‹ ì ëª©ë¡ ìƒì„±
const recipientList = [];
if (emailData.recipients.includes("assigner")) { ... }
if (emailData.recipients.includes("assignee")) { ... }

// 2. ê° ìˆ˜ì‹ ìì—ê²Œ ì´ë©”ì¼ ë°œì†¡
const results = await Promise.all(
  recipientList.map(async (recipient) => {
    // ì´ë©”ì¼ í…œí”Œë¦¿ ìƒì„±
    const { subject, html } = getEmailTemplate(emailData, recipient.role);
    
    // ì´ë©”ì¼ ë°œì†¡ (ì¬ì‹œë„ ë¡œì§ í¬í•¨)
    const result = await sendEmail(transporter, recipient.email, subject, html);
    
    // email_logsì— ê¸°ë¡
    await supabase.from("email_logs").insert({
      task_id: emailData.taskId,
      recipient_email: recipient.email,
      recipient_name: recipient.name,
      subject,
      status: result.success ? "sent" : "failed",
      error_message: result.error || null,
      sent_at: result.success ? new Date().toISOString() : null,
    });
    
    return result;
  })
);
```

#### 4.5 ì´ë©”ì¼ ë°œì†¡ í•¨ìˆ˜ (ì¬ì‹œë„ ë¡œì§ í¬í•¨)
```typescript
async function sendEmail(
  transporter: any,
  to: string,
  subject: string,
  html: string,
  maxRetries: number = 3
): Promise<{ success: boolean; error?: string }> {
  let lastError: Error | null = null;
  
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      await transporter.sendMail({
        from: Deno.env.get("SMTP_USER"),
        to,
        subject,
        html,
      });
      return { success: true };
    } catch (error) {
      lastError = error as Error;
      if (attempt < maxRetries) {
        await new Promise((resolve) => setTimeout(resolve, 1000 * attempt));
      }
    }
  }
  
  return {
    success: false,
    error: lastError?.message || "Unknown error",
  };
}
```

**ë¡œê¹…**:
- `console.log("[send-task-email] Request received:", ...)`
- `console.log("[send-task-email] Email data received:", ...)`
- `console.log("[send-task-email] SMTP config check:", ...)`
- `console.log("[send-task-email] Sending email to ...")`
- `console.log("[send-task-email] Email result for ...")`
- `console.error("[send-task-email] Failed to log email ...")`

---

### 5ë‹¨ê³„: email_logs í…Œì´ë¸”ì— ê¸°ë¡

**í…Œì´ë¸” êµ¬ì¡°**:
```sql
CREATE TABLE public.email_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  task_id UUID NOT NULL REFERENCES public.tasks(id) ON DELETE CASCADE,
  recipient_email TEXT NOT NULL,
  recipient_name TEXT,
  subject TEXT NOT NULL,
  status TEXT NOT NULL CHECK (status IN ('pending', 'sent', 'failed')),
  error_message TEXT,
  retry_count INTEGER NOT NULL DEFAULT 0,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  sent_at TIMESTAMPTZ
);
```

**ê¸°ë¡ ì‹œì **:
- Edge Functionì—ì„œ ì´ë©”ì¼ ë°œì†¡ ì‹œë„ í›„
- ì„±ê³µ ì‹œ: `status = 'sent'`, `sent_at` ì„¤ì •
- ì‹¤íŒ¨ ì‹œ: `status = 'failed'`, `error_message` ì„¤ì •

**RLS ì •ì±…**:
- SELECT: Taskì— ì ‘ê·¼ ê¶Œí•œì´ ìˆëŠ” ì‚¬ìš©ìë§Œ ì¡°íšŒ ê°€ëŠ¥
- INSERT: Service Role Keyë¥¼ ì‚¬ìš©í•˜ëŠ” Edge Functionë§Œ ì‚½ì… ê°€ëŠ¥

---

## âš ï¸ email_logsì— ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°

### ê°€ëŠ¥í•œ ì›ì¸

1. **íŠ¸ë¦¬ê±°ê°€ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ**
   - íŠ¸ë¦¬ê±°ê°€ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŒ
   - íŠ¸ë¦¬ê±° í•¨ìˆ˜ì—ì„œ ì—ëŸ¬ ë°œìƒ
   - íŠ¸ë¦¬ê±° ì¡°ê±´ì´ ë§ì§€ ì•ŠìŒ

2. **Edge Functionì´ í˜¸ì¶œë˜ì§€ ì•ŠìŒ**
   - `net.http_post` í˜¸ì¶œ ì‹¤íŒ¨
   - ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ
   - Edge Function URL ì˜¤ë¥˜

3. **Edge Functionì´ í˜¸ì¶œë˜ì—ˆì§€ë§Œ ì—ëŸ¬ ë°œìƒ**
   - ìš”ì²­ ë³¸ë¬¸ íŒŒì‹± ì‹¤íŒ¨
   - í•„ìˆ˜ í•„ë“œ ëˆ„ë½
   - SMTP ì„¤ì • ì˜¤ë¥˜
   - Supabase í´ë¼ì´ì–¸íŠ¸ ìƒì„± ì‹¤íŒ¨

4. **ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨ í›„ ë¡œê·¸ ê¸°ë¡ ì‹¤íŒ¨**
   - `supabase.from("email_logs").insert()` í˜¸ì¶œ ì‹¤íŒ¨
   - RLS ì •ì±… ë¬¸ì œ
   - ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ë¬¸ì œ

---

## ğŸ” ì§„ë‹¨ ë°©ë²•

### 1. íŠ¸ë¦¬ê±° ì‹¤í–‰ í™•ì¸

**Postgres Logs í™•ì¸**:
- Supabase Dashboard â†’ Logs â†’ Postgres Logs
- `[EMAIL_TRIGGER]` ê²€ìƒ‰
- íŠ¸ë¦¬ê±° ì‹¤í–‰ ë©”ì‹œì§€ í™•ì¸

**SQLë¡œ í™•ì¸**:
```sql
-- ìµœê·¼ Task ìƒì„±/ìƒíƒœ ë³€ê²½ í™•ì¸
SELECT 
  id,
  title,
  task_status,
  created_at,
  updated_at
FROM public.tasks
ORDER BY created_at DESC
LIMIT 10;
```

### 2. Edge Function í˜¸ì¶œ í™•ì¸

**Edge Function Logs í™•ì¸**:
- Supabase Dashboard â†’ Edge Functions â†’ send-task-email â†’ Logs
- `[send-task-email]` ê²€ìƒ‰
- ìš”ì²­ ìˆ˜ì‹  ë©”ì‹œì§€ í™•ì¸

**Postgres Logsì—ì„œ HTTP ìš”ì²­ ID í™•ì¸**:
- `[EMAIL_TRIGGER] HTTP request submitted with ID: [id]` ë©”ì‹œì§€ í™•ì¸

### 3. Edge Function ì—ëŸ¬ í™•ì¸

**Edge Function Logsì—ì„œ í™•ì¸**:
- `[send-task-email] Error sending email:` ë©”ì‹œì§€
- `[send-task-email] SMTP credentials not configured` ë©”ì‹œì§€
- `[send-task-email] Failed to log email` ë©”ì‹œì§€

### 4. email_logs ê¸°ë¡ í™•ì¸

**SQLë¡œ í™•ì¸**:
```sql
SELECT 
  id,
  task_id,
  recipient_email,
  status,
  error_message,
  created_at
FROM public.email_logs
ORDER BY created_at DESC
LIMIT 20;
```

---

## ğŸ› ï¸ ë¬¸ì œ í•´ê²° ì²´í¬ë¦¬ìŠ¤íŠ¸

### Step 1: íŠ¸ë¦¬ê±° ì‹¤í–‰ í™•ì¸
- [ ] Postgres Logsì— `[EMAIL_TRIGGER]` ë©”ì‹œì§€ê°€ ìˆëŠ”ì§€ í™•ì¸
- [ ] íŠ¸ë¦¬ê±°ê°€ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
- [ ] íŠ¸ë¦¬ê±° í•¨ìˆ˜ì— ì—ëŸ¬ê°€ ì—†ëŠ”ì§€ í™•ì¸

### Step 2: Edge Function í˜¸ì¶œ í™•ì¸
- [ ] Edge Function Logsì— ìš”ì²­ì´ ìˆëŠ”ì§€ í™•ì¸
- [ ] Postgres Logsì— HTTP ìš”ì²­ IDê°€ ìˆëŠ”ì§€ í™•ì¸
- [ ] `net.http_post` í˜¸ì¶œì´ ì„±ê³µí–ˆëŠ”ì§€ í™•ì¸

### Step 3: Edge Function ì‹¤í–‰ í™•ì¸
- [ ] ìš”ì²­ ë³¸ë¬¸ íŒŒì‹±ì´ ì„±ê³µí–ˆëŠ”ì§€ í™•ì¸
- [ ] í•„ìˆ˜ í•„ë“œê°€ ëª¨ë‘ ìˆëŠ”ì§€ í™•ì¸
- [ ] SMTP ì„¤ì •ì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸
- [ ] Supabase í´ë¼ì´ì–¸íŠ¸ ìƒì„±ì´ ì„±ê³µí–ˆëŠ”ì§€ í™•ì¸

### Step 4: ì´ë©”ì¼ ë°œì†¡ í™•ì¸
- [ ] ì´ë©”ì¼ ë°œì†¡ ì‹œë„ê°€ ìˆì—ˆëŠ”ì§€ í™•ì¸
- [ ] ì´ë©”ì¼ ë°œì†¡ ì„±ê³µ/ì‹¤íŒ¨ ì—¬ë¶€ í™•ì¸
- [ ] ì—ëŸ¬ ë©”ì‹œì§€ í™•ì¸

### Step 5: email_logs ê¸°ë¡ í™•ì¸
- [ ] `supabase.from("email_logs").insert()` í˜¸ì¶œì´ ìˆì—ˆëŠ”ì§€ í™•ì¸
- [ ] RLS ì •ì±… ë¬¸ì œê°€ ì—†ëŠ”ì§€ í™•ì¸
- [ ] ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì´ ì •ìƒì¸ì§€ í™•ì¸

---

## ğŸ“ í˜„ì¬ ìƒíƒœ í™•ì¸

**í™•ì¸ëœ ì‚¬í•­**:
- âœ… íŠ¸ë¦¬ê±° í™œì„±í™” ìƒíƒœ: ë‘ íŠ¸ë¦¬ê±° ëª¨ë‘ í™œì„±í™”ë¨
- âœ… íŠ¸ë¦¬ê±° í•¨ìˆ˜: í•˜ë“œì½”ë”© ë°©ì‹, ë¡œê¹… ì¶”ê°€ë¨
- âœ… Edge Function ë°°í¬ ìƒíƒœ: ë°°í¬ë˜ì–´ ìˆê³  í™œì„±í™”ë¨
- âš ï¸ Edge Function Logs: ë¹„ì–´ìˆìŒ (í˜¸ì¶œë˜ì§€ ì•Šì•˜ì„ ê°€ëŠ¥ì„±)
- âš ï¸ email_logs: ë°ì´í„° ì—†ìŒ

**ë‹¤ìŒ ë‹¨ê³„**:
1. Task ìƒì„± ë˜ëŠ” ìƒíƒœ ë³€ê²½ í…ŒìŠ¤íŠ¸
2. Postgres Logsì—ì„œ `[EMAIL_TRIGGER]` ë©”ì‹œì§€ í™•ì¸
3. Edge Function Logsì—ì„œ ìš”ì²­ í™•ì¸
4. ë¬¸ì œ ì§€ì† ì‹œ ê° ë‹¨ê³„ë³„ ìƒì„¸ ì§„ë‹¨

---

## ğŸ”— ê´€ë ¨ íŒŒì¼

- `supabase/migrations/20250101000028_fix_email_triggers_final.sql`: íŠ¸ë¦¬ê±° í•¨ìˆ˜
- `supabase/functions/send-task-email/index.ts`: Edge Function ì½”ë“œ
- `supabase/migrations/20250101000004_create_email_logs_table.sql`: email_logs í…Œì´ë¸” ìƒì„±
- `supabase/migrations/20250101000009_create_rls_policies_email_logs.sql`: RLS ì •ì±…


