# 읽음 처리 정책 최종 정리

## 📋 핵심 원칙

**읽음 처리는 오직 지시자(assigner) ↔ 담당자(assignee) 간에만 이루어집니다.**

---

## 🎯 읽음 처리 규칙

### 1. 읽음 처리 주체
- **지시자(assigner)**: Task를 생성하고 담당자에게 할당한 사용자
- **담당자(assignee)**: Task를 수행하는 사용자
- **관리자(Admin)**: 
  - 지시자 또는 담당자인 경우: 일반 사용자와 동일하게 읽음 처리
  - 제3자인 경우: 읽음 처리에 영향 없음

### 2. 읽음 처리 시나리오

#### 시나리오 1: 지시자가 메시지를 보낸 경우
```
지시자 → 메시지 전송
담당자 → 메시지 확인 (채팅창 진입 또는 메시지 확인)
결과: 지시자의 메시지 밑에 "읽음" 표시
```

#### 시나리오 2: 담당자가 메시지를 보낸 경우
```
담당자 → 메시지 전송
지시자 → 메시지 확인 (채팅창 진입 또는 메시지 확인)
결과: 담당자의 메시지 밑에 "읽음" 표시
```

### 3. 읽음 처리 조건

#### ✅ 읽음 처리가 되는 경우
1. **지시자가 보낸 메시지** → **담당자가 읽은 경우**
   - 담당자가 채팅창에 진입하여 메시지를 확인
   - 담당자가 실시간으로 메시지를 수신하고 확인

2. **담당자가 보낸 메시지** → **지시자가 읽은 경우**
   - 지시자가 채팅창에 진입하여 메시지를 확인
   - 지시자가 실시간으로 메시지를 수신하고 확인

#### ❌ 읽음 처리가 되지 않는 경우
1. **관리자가 제3자인 경우**
   - 관리자가 지시자/담당자가 아닌 경우
   - 관리자가 메시지를 읽어도 읽음 처리 안 됨

2. **본인이 보낸 메시지**
   - 본인이 보낸 메시지는 읽음 표시 안 됨 (당연함)

3. **상대방이 아닌 경우**
   - 지시자/담당자가 아닌 사용자가 메시지를 읽어도 읽음 처리 안 됨

---

## 🔍 기술적 구현 요구사항

### 1. 데이터베이스 레벨

#### `mark_message_as_read` 함수
```sql
-- 읽음 처리 조건
IF (is_sender_assigner AND is_reader_assignee) OR
   (is_sender_assignee AND is_reader_assigner) THEN
  -- 읽음 처리 실행
END IF;
```

**동작 방식**:
- 지시자가 보낸 메시지 → 담당자가 읽은 경우만 처리
- 담당자가 보낸 메시지 → 지시자가 읽은 경우만 처리
- 그 외의 경우는 처리하지 않음

#### `mark_task_messages_as_read` 함수
```sql
-- Task의 모든 메시지에 대해 읽음 처리
-- 단, 상대방(assigner 또는 assignee)이 보낸 메시지만 처리
WHERE (
  -- 지시자가 읽는 경우: 담당자가 보낸 메시지만 읽음 처리
  (is_reader_assigner AND user_id = task_record.assignee_id) OR
  -- 담당자가 읽는 경우: 지시자가 보낸 메시지만 읽음 처리
  (is_reader_assignee AND user_id = task_record.assigner_id)
)
```

**동작 방식**:
- 채팅창 진입 시 모든 메시지를 읽음 처리
- 단, 상대방이 보낸 메시지만 읽음 처리
- 본인이 보낸 메시지는 읽음 처리 안 됨

### 2. 프론트엔드 레벨

#### 읽음 상태 확인 함수
```typescript
isMessageReadByCounterpart(
  message: MessageWithProfile,
  currentUserId: string,
  task: { assigner_id: string; assignee_id: string }
): boolean
```

**동작 방식**:
1. 본인이 보낸 메시지인지 확인
2. 현재 사용자가 지시자/담당자인지 확인
3. 상대방 ID 확인 (지시자 메시지 → 담당자 확인, 담당자 메시지 → 지시자 확인)
4. `read_by` 배열에 상대방 ID가 있는지 확인

#### 읽음 표시 UI
- **위치**: 본인이 보낸 메시지 밑에 표시
- **표시 조건**: 
  - 본인이 보낸 메시지
  - 상대방(지시자 또는 담당자)이 읽은 경우
- **표시 텍스트**: "읽음"

---

## 📊 읽음 처리 흐름도

### 케이스 1: 지시자가 메시지 전송 → 담당자가 확인

```
1. 지시자가 메시지 전송
   └─> messages 테이블에 INSERT
   └─> read_by: []

2. 담당자가 채팅창 진입 또는 메시지 확인
   └─> mark_task_messages_as_read 호출
   └─> 지시자가 보낸 메시지의 read_by에 담당자 ID 추가

3. Realtime UPDATE 이벤트 발생
   └─> 프론트엔드에서 메시지 목록 갱신

4. UI 업데이트
   └─> 지시자의 메시지 밑에 "읽음" 표시
```

### 케이스 2: 담당자가 메시지 전송 → 지시자가 확인

```
1. 담당자가 메시지 전송
   └─> messages 테이블에 INSERT
   └─> read_by: []

2. 지시자가 채팅창 진입 또는 메시지 확인
   └─> mark_task_messages_as_read 호출
   └─> 담당자가 보낸 메시지의 read_by에 지시자 ID 추가

3. Realtime UPDATE 이벤트 발생
   └─> 프론트엔드에서 메시지 목록 갱신

4. UI 업데이트
   └─> 담당자의 메시지 밑에 "읽음" 표시
```

---

## ⚠️ 주의사항

### 1. 읽음 처리 제한
- **오직 지시자 ↔ 담당자 간에만** 읽음 처리
- 관리자가 제3자인 경우 읽음 처리 안 됨
- 다른 사용자가 메시지를 읽어도 읽음 처리 안 됨

### 2. 실시간 반영
- 읽음 처리는 실시간으로 반영되어야 함
- Realtime UPDATE 이벤트를 통해 즉시 UI 업데이트
- 읽음 상태 변경 시 즉시 "읽음" 표시

### 3. 중복 방지
- 이미 읽은 메시지는 중복 처리하지 않음
- `read_by` 배열에 이미 사용자 ID가 있으면 처리 안 함

---

## 🎯 최종 요구사항 요약

1. **읽음 처리는 지시자 ↔ 담당자 간에만 이루어짐**
2. **지시자가 보낸 메시지 → 담당자가 읽으면 → 지시자 메시지 밑에 "읽음" 표시**
3. **담당자가 보낸 메시지 → 지시자가 읽으면 → 담당자 메시지 밑에 "읽음" 표시**
4. **관리자가 제3자인 경우 읽음 처리에 영향 없음**
5. **읽음 처리는 실시간으로 반영되어야 함**
6. **본인이 보낸 메시지에만 "읽음" 표시**

---

## 📝 구현 체크리스트

### 백엔드
- [ ] `mark_message_as_read` 함수가 지시자/담당자 간 읽음 처리만 수행하는지 확인
- [ ] `mark_task_messages_as_read` 함수가 상대방 메시지만 읽음 처리하는지 확인
- [ ] RLS 정책이 올바르게 설정되어 있는지 확인
- [ ] Realtime publication이 활성화되어 있는지 확인

### 프론트엔드
- [ ] `isMessageReadByCounterpart` 함수가 올바르게 작동하는지 확인
- [ ] 읽음 표시가 본인 메시지에만 나타나는지 확인
- [ ] 읽음 상태가 실시간으로 반영되는지 확인
- [ ] Realtime UPDATE 이벤트가 제대로 처리되는지 확인

---

**마지막 업데이트**: 2025-01-10


