-- ============================================================================
-- Task 삭제 정책 수정: 지시자만 삭제 가능하도록 변경
-- ============================================================================
-- 목적: Task 생성자(지시자)만 Task를 삭제할 수 있도록 RLS 정책 수정
-- 
-- 변경 사항:
-- 1. tasks_delete_admin_only 정책 제거 (관리자만 삭제 가능)
-- 2. tasks_delete_assigner_only 정책 생성 (지시자만 삭제 가능)
-- 
-- 요구사항:
-- - Task 생성자(지시자, assigner_id)만 삭제 가능
-- - 관리자는 삭제 불가 (지시자가 아닌 경우)
-- ============================================================================

BEGIN;

-- ----------------------------------------------------------------------------
-- 1. 기존 DELETE 정책 제거
-- ----------------------------------------------------------------------------

-- 관리자만 삭제 가능한 정책 제거
DROP POLICY IF EXISTS "tasks_delete_admin_only" ON public.tasks;

-- 지시자만 삭제 가능한 정책이 이미 존재하는 경우 제거 (재생성을 위해)
DROP POLICY IF EXISTS "tasks_delete_assigner_only" ON public.tasks;

-- ----------------------------------------------------------------------------
-- 2. 새로운 DELETE 정책 생성: 지시자만 삭제 가능
-- ----------------------------------------------------------------------------

CREATE POLICY "tasks_delete_assigner_only"
ON public.tasks
FOR DELETE
USING (auth.uid() = assigner_id);

-- ----------------------------------------------------------------------------
-- 3. 정책 코멘트 추가
-- ----------------------------------------------------------------------------

COMMENT ON POLICY "tasks_delete_assigner_only" ON public.tasks IS 
'태스크 삭제 정책: 지시자만 태스크 삭제 가능. Task 생성자(assigner_id)만 자신이 생성한 Task를 삭제할 수 있습니다. 관리자도 지시자가 아니면 삭제할 수 없습니다.';

COMMIT;
