-- ============================================================================
-- 프로필 조회 정책 수정: 태스크 생성 시 활성 사용자 프로필 조회 허용
-- ============================================================================
-- 목적: 태스크 생성 시 담당자 선택을 위해 활성 상태인 사용자 프로필 조회 허용
-- 
-- 문제:
-- - 프로젝트 구조 제거 후 can_access_profile 함수가 Task 기반으로만 작동
-- - 태스크 생성 시에는 아직 Task가 없어서 다른 사용자 프로필 조회 불가
-- - 멤버가 태스크 생성 시 담당자 선택 드롭다운이 비어있음
-- 
-- 해결:
-- - 인증된 사용자는 활성 상태인 프로필을 조회할 수 있도록 정책 추가
-- ============================================================================

BEGIN;

-- ----------------------------------------------------------------------------
-- profiles 테이블 RLS 정책 추가
-- ----------------------------------------------------------------------------
-- 인증된 사용자는 활성 상태인 프로필을 조회할 수 있도록 허용
-- 이렇게 하면 태스크 생성 시 담당자 선택이 가능합니다

CREATE POLICY "profiles_select_active_for_authenticated"
ON public.profiles
FOR SELECT
TO authenticated
USING (
  is_active = true
  AND profile_completed = true
);

COMMENT ON POLICY "profiles_select_active_for_authenticated" ON public.profiles IS 
'인증된 사용자는 활성 상태이고 프로필이 완료된 사용자의 프로필을 조회할 수 있습니다. 태스크 생성 시 담당자 선택을 위해 필요합니다.';

COMMIT;
