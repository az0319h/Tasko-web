# 이메일 전송 문제 해결 가이드

## 🎯 목표
이메일이 전송되지 않는 문제를 단계별로 진단하고 해결합니다.

---

## 📋 1단계: 데이터베이스 상태 확인

### 실행 방법
1. Supabase Dashboard 접속
2. SQL Editor 열기
3. `이메일_문제_진단_실행.sql` 파일의 내용을 복사하여 실행

### 확인 사항
- ✅ 트리거가 활성화되어 있는지
- ✅ 트리거 함수가 하드코딩 방식인지
- ✅ `pg_net` 확장이 설치되어 있는지
- ✅ `net.http_post` 함수 시그니처 확인
- ✅ 이메일 로그에 발송 시도가 있는지

### 예상 결과
- 트리거 상태: `✅ 활성화됨`
- URL 설정: `✅ 하드코딩됨`
- 인증 설정: `✅ 하드코딩됨`
- HTTP 호출: `✅ http_post 사용`

---

## 📋 2단계: Edge Function 배포 확인

### 실행 방법
터미널에서 다음 명령어 실행:

```bash
# Edge Function 목록 확인
supabase functions list --project-ref dcovjxmrqomuuwcgiwie

# Edge Function 로그 확인
supabase functions logs send-task-email --project-ref dcovjxmrqomuuwcgiwie --limit 50
```

### 확인 사항
- ✅ `send-task-email` 함수가 목록에 있는지
- ✅ 최근 호출 로그가 있는지
- ✅ 에러 메시지가 있는지

### 예상 결과
- 함수 목록에 `send-task-email` 표시
- 최근 호출 로그에 요청 기록 있음
- 에러 메시지 없음

---

## 📋 3단계: Edge Function 직접 테스트

### 실행 방법
터미널에서 다음 명령어 실행 (이메일 주소를 실제 주소로 변경):

```bash
curl -X POST \
  'https://dcovjxmrqomuuwcgiwie.supabase.co/functions/v1/send-task-email' \
  -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRjb3ZqeG1ycW9tdXV3Y2dpd2llIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NjAwNjMyNywiZXhwIjoyMDgxNTgyMzI3fQ.0nK3qmclkR2urRsAytgRthpdb-OwaX6rJLLiOIsQH1o' \
  -H 'Content-Type: application/json' \
  -d '{
    "eventType": "STATUS_CHANGED",
    "taskId": "test-task-id",
    "oldStatus": "ASSIGNED",
    "newStatus": "IN_PROGRESS",
    "assignerEmail": "your-email@example.com",
    "assigneeEmail": "your-email@example.com",
    "assignerName": "지시자",
    "assigneeName": "담당자",
    "taskTitle": "테스트 Task",
    "projectTitle": "테스트 프로젝트",
    "recipients": ["assigner", "assignee"]
  }'
```

### 확인 사항
- ✅ 응답이 `{"success": true, ...}` 형태인지
- ✅ 실제 이메일이 수신되는지
- ✅ 에러 메시지가 있는지

### 예상 결과
- 응답: `{"success": true, "message": "Emails sent successfully", ...}`
- 실제 이메일 수신 확인

### 문제 발생 시
- **SMTP 인증 실패**: `SMTP_USER`, `SMTP_PASS` 확인
- **환경 변수 없음**: Supabase Secrets 확인
- **기타 에러**: Edge Function 로그 확인

---

## 📋 4단계: 트리거 함수 수정 (로깅 추가)

### 문제: 트리거 실행 여부 확인 불가

### 해결 방법
`supabase/migrations/20250101000027_fix_email_triggers_with_logging.sql` 파일을 실행합니다.

### 실행 방법
1. Supabase Dashboard → SQL Editor
2. 파일 내용 복사하여 실행

### 변경 사항
- ✅ 트리거 실행 시 로깅 추가
- ✅ HTTP 요청 ID 로깅
- ✅ 에러 상세 정보 로깅
- ✅ `net.http_post` 시그니처 수정 (`url, headers, body` 형식)

### 확인 방법
Task 생성/상태 변경 후:
1. Supabase Dashboard → Logs → Postgres Logs
2. `[send_task_created_email]` 또는 `[send_task_status_change_email]` 검색
3. 로그 메시지 확인

---

## 📋 5단계: net.http_post 시그니처 확인

### 문제: 함수 시그니처 불일치 가능성

### 현재 사용 중인 형식 (20250101000026)
```sql
PERFORM net.http_post(
  url := function_url,
  body := request_body,
  params := '{}'::jsonb,
  headers := jsonb_build_object(...)
);
```

### 올바른 형식 (20250101000027)
```sql
SELECT net.http_post(
  url := function_url,
  headers := jsonb_build_object(...),
  body := request_body::text
) INTO http_response_id;
```

### 확인 방법
SQL Editor에서 실행:
```sql
SELECT 
  p.proname AS function_name,
  pg_get_function_arguments(p.oid) AS arguments
FROM pg_proc p
JOIN pg_namespace n ON p.pronamespace = n.oid
WHERE n.nspname = 'net' 
  AND p.proname = 'http_post';
```

### 해결 방법
`20250101000027_fix_email_triggers_with_logging.sql` 마이그레이션을 적용하면 올바른 시그니처로 수정됩니다.

---

## 📋 6단계: 환경 변수 확인

### 확인 사항
Supabase Dashboard → Settings → Secrets에서 다음 변수 확인:

- ✅ `SMTP_USER`: `bass.to.tasko@gmail.com`
- ✅ `SMTP_PASS`: Gmail 앱 비밀번호
- ✅ `SUPABASE_URL`: `https://dcovjxmrqomuuwcgiwie.supabase.co`
- ✅ `SUPABASE_SERVICE_ROLE_KEY`: Service Role Key
- ✅ `FRONTEND_URL`: 프론트엔드 URL

### 확인 방법
이미지에서 확인한 것처럼 모든 변수가 설정되어 있어야 합니다.

### 문제 발생 시
터미널에서 다시 설정:
```bash
supabase secrets set SMTP_USER=bass.to.tasko@gmail.com --project-ref dcovjxmrqomuuwcgiwie
supabase secrets set SMTP_PASS="your-app-password" --project-ref dcovjxmrqomuuwcgiwie
supabase secrets set SUPABASE_URL=https://dcovjxmrqomuuwcgiwie.supabase.co --project-ref dcovjxmrqomuuwcgiwie
supabase secrets set SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRjb3ZqeG1ycW9tdXV3Y2dpd2llIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NjAwNjMyNywiZXhwIjoyMDgxNTgyMzI3fQ.0nK3qmclkR2urRsAytgRthpdb-OwaX6rJLLiOIsQH1o --project-ref dcovjxmrqomuuwcgiwie
supabase secrets set FRONTEND_URL=https://your-frontend-url.com --project-ref dcovjxmrqomuuwcgiwie
```

---

## 📋 7단계: 이메일 로그 확인

### 확인 방법
SQL Editor에서 실행:
```sql
SELECT 
  id,
  task_id,
  recipient_email,
  status,
  error_message,
  created_at
FROM public.email_logs
ORDER BY created_at DESC
LIMIT 20;
```

### 확인 사항
- ✅ 발송 시도 기록이 있는지
- ✅ 실패한 이메일의 에러 메시지 확인
- ✅ 최근 발송 시도 시간 확인

### 문제 발생 시
- **로그가 없음**: 트리거가 실행되지 않음 → 트리거 확인
- **실패 로그 있음**: 에러 메시지 확인 → Edge Function 로그 확인
- **성공 로그 있음**: 실제 이메일 수신 확인 → 스팸 폴더 확인

---

## 🔧 종합 해결 방안

### 즉시 실행할 항목 (우선순위 순)

1. **데이터베이스 상태 확인** (1단계)
   - `이메일_문제_진단_실행.sql` 실행
   - 트리거 및 함수 상태 확인

2. **Edge Function 직접 테스트** (3단계)
   - curl 명령어로 직접 호출
   - SMTP 설정 확인

3. **트리거 함수 수정** (4단계)
   - `20250101000027_fix_email_triggers_with_logging.sql` 실행
   - 로깅 추가 및 시그니처 수정

4. **Edge Function 로그 확인** (2단계)
   - 최근 호출 기록 확인
   - 에러 메시지 확인

5. **이메일 로그 확인** (7단계)
   - 발송 시도 기록 확인
   - 실패한 이메일의 에러 메시지 확인

### 문제별 해결 방법

#### 문제 1: 트리거가 실행되지 않음
- **증상**: 이메일 로그에 기록이 없음
- **해결**: 트리거 활성화 확인, 트리거 함수 수정

#### 문제 2: Edge Function이 호출되지 않음
- **증상**: 트리거는 실행되지만 Edge Function 로그에 요청이 없음
- **해결**: `net.http_post` 시그니처 확인, 트리거 함수 수정

#### 문제 3: SMTP 인증 실패
- **증상**: Edge Function 로그에 SMTP 인증 오류
- **해결**: `SMTP_USER`, `SMTP_PASS` 확인, Gmail 앱 비밀번호 확인

#### 문제 4: 이메일이 스팸 폴더로 이동
- **증상**: 이메일이 발송되었지만 받지 못함
- **해결**: 스팸 폴더 확인, 발신자 이메일 주소 확인

---

## 📝 체크리스트

진행 상황을 체크하세요:

- [ ] 1단계: 데이터베이스 상태 확인 완료
- [ ] 2단계: Edge Function 배포 확인 완료
- [ ] 3단계: Edge Function 직접 테스트 완료
- [ ] 4단계: 트리거 함수 수정 완료
- [ ] 5단계: net.http_post 시그니처 확인 완료
- [ ] 6단계: 환경 변수 확인 완료
- [ ] 7단계: 이메일 로그 확인 완료
- [ ] 실제 이메일 수신 확인 완료

---

## 🚀 다음 단계

위 단계를 모두 완료한 후에도 문제가 지속되면:

1. **Supabase 지원팀 문의**
   - `pg_net` 확장 관련 문제 가능성
   - Edge Function 호출 문제 가능성

2. **대안 방법 고려**
   - Edge Function 대신 다른 방식 사용
   - 큐 시스템 도입 고려

3. **로깅 강화**
   - 더 상세한 로깅 추가
   - 모니터링 시스템 구축

---

## 📚 참고 파일

- `이메일_전송_문제_종합_분석.md`: 전체 분석 보고서
- `이메일_문제_진단_실행.sql`: 진단 SQL 쿼리
- `supabase/migrations/20250101000027_fix_email_triggers_with_logging.sql`: 트리거 함수 수정 마이그레이션
- `supabase/functions/send-task-email/index.ts`: Edge Function 코드

---

## 💡 핵심 포인트

1. **Service Role Key**: ✅ 사용자 제공 키와 마이그레이션 파일의 키가 동일함
2. **환경 변수**: ✅ 이미지에서 모든 필수 환경 변수가 설정되어 있음
3. **트리거 함수**: ⚠️ `net.http_post` 시그니처 확인 필요
4. **Edge Function**: ⚠️ 배포 상태 및 호출 여부 확인 필요
5. **로깅**: ⚠️ 트리거 실행 여부 확인을 위한 로깅 추가 필요

**권장 순서**: 1단계 → 3단계 → 4단계 → 2단계 → 7단계


