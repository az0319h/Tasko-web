# ì´ë©”ì¼ ì „ì†¡ ë¬¸ì œ ìˆ˜ì • ì™„ë£Œ ìš”ì•½

## âœ… ìˆ˜ì • ì™„ë£Œ ì‚¬í•­

### 1. íŠ¸ë¦¬ê±° í•¨ìˆ˜ ìˆ˜ì •
- âœ… `send_task_created_email`: í•˜ë“œì½”ë”© ë°©ì‹ìœ¼ë¡œ í†µì¼ (í™˜ê²½ ë³€ìˆ˜ ì œê±°)
- âœ… `send_task_status_change_email`: í•˜ë“œì½”ë”© ë°©ì‹ ìœ ì§€
- âœ… ë‘ í•¨ìˆ˜ ëª¨ë‘ ë¡œê¹… ì¶”ê°€ (`RAISE NOTICE` ì‚¬ìš©)
- âœ… `net.http_post` ì‹œê·¸ë‹ˆì²˜ë¥¼ ì˜¬ë°”ë¥¸ í˜•ì‹ìœ¼ë¡œ ìˆ˜ì •
  - ì˜¬ë°”ë¥¸ í˜•ì‹: `net.http_post(url text, body jsonb, params jsonb, headers jsonb)`

### 2. í™•ì¸ëœ ì‚¬í•­
- âœ… íŠ¸ë¦¬ê±° í™œì„±í™” ìƒíƒœ: ë‘ íŠ¸ë¦¬ê±° ëª¨ë‘ í™œì„±í™”ë¨
- âœ… Edge Function ë°°í¬ ìƒíƒœ: `send-task-email` í•¨ìˆ˜ê°€ ë°°í¬ë˜ì–´ ìˆê³  í™œì„±í™”ë¨
- âœ… `pg_net` í™•ì¥: ì„¤ì¹˜ë˜ì–´ ìˆìŒ (ë²„ì „ 0.19.5)

## ğŸ”§ ìˆ˜ì • ë‚´ìš© ìƒì„¸

### net.http_post ì‹œê·¸ë‹ˆì²˜ ìˆ˜ì •
**ì´ì „ (ì˜ëª»ëœ í˜•ì‹)**:
```sql
PERFORM net.http_post(
  url := function_url,
  headers := jsonb_build_object(...),
  body := request_body::text  -- âŒ textë¡œ ë³€í™˜
);
```

**ìˆ˜ì • í›„ (ì˜¬ë°”ë¥¸ í˜•ì‹)**:
```sql
SELECT net.http_post(
  url := function_url,
  body := request_body,      -- âœ… jsonb ê·¸ëŒ€ë¡œ ì „ë‹¬
  params := '{}'::jsonb,
  headers := jsonb_build_object(...)
) INTO http_response_id;      -- âœ… ì‘ë‹µ ID ì €ì¥
```

### ë¡œê¹… ì¶”ê°€
íŠ¸ë¦¬ê±° í•¨ìˆ˜ ì‹¤í–‰ ì‹œ ë‹¤ìŒ ì •ë³´ë¥¼ ë¡œê¹…í•©ë‹ˆë‹¤:
- íŠ¸ë¦¬ê±° ì‹¤í–‰ í™•ì¸
- Edge Function í˜¸ì¶œ URL
- ìš”ì²­ ë³¸ë¬¸ (request_body)
- HTTP ìš”ì²­ ID
- ì—ëŸ¬ ë°œìƒ ì‹œ ìƒì„¸ ì •ë³´

## ğŸ“‹ ë‹¤ìŒ ë‹¨ê³„

### 1. í…ŒìŠ¤íŠ¸ ë°©ë²•

#### Task ìƒì„± í…ŒìŠ¤íŠ¸
1. ìƒˆ Taskë¥¼ ìƒì„±í•©ë‹ˆë‹¤
2. Supabase Dashboard â†’ Logs â†’ Postgres Logsì—ì„œ `[EMAIL_TRIGGER]` ê²€ìƒ‰
3. ë¡œê·¸ ë©”ì‹œì§€ í™•ì¸:
   - `[EMAIL_TRIGGER] Task created: [task_id]`
   - `[EMAIL_TRIGGER] Calling Edge Function: ...`
   - `[EMAIL_TRIGGER] HTTP request submitted with ID: ...`

#### Task ìƒíƒœ ë³€ê²½ í…ŒìŠ¤íŠ¸
1. Task ìƒíƒœë¥¼ ë³€ê²½í•©ë‹ˆë‹¤ (ì˜ˆ: ASSIGNED â†’ IN_PROGRESS)
2. Postgres Logsì—ì„œ `[EMAIL_TRIGGER]` ê²€ìƒ‰
3. ë¡œê·¸ ë©”ì‹œì§€ í™•ì¸:
   - `[EMAIL_TRIGGER] Status changed: ASSIGNED -> IN_PROGRESS (task: [task_id])`
   - `[EMAIL_TRIGGER] Calling Edge Function: ...`
   - `[EMAIL_TRIGGER] HTTP request submitted with ID: ...`

### 2. Edge Function ë¡œê·¸ í™•ì¸
Supabase Dashboard â†’ Edge Functions â†’ send-task-email â†’ Logsì—ì„œ:
- Edge Function í˜¸ì¶œ ì—¬ë¶€ í™•ì¸
- SMTP ì„¤ì • ì˜¤ë¥˜ í™•ì¸
- ì´ë©”ì¼ ë°œì†¡ ì„±ê³µ/ì‹¤íŒ¨ í™•ì¸

### 3. ì´ë©”ì¼ ë¡œê·¸ í™•ì¸
```sql
SELECT 
  id,
  task_id,
  recipient_email,
  status,
  error_message,
  created_at
FROM public.email_logs
ORDER BY created_at DESC
LIMIT 20;
```

### 4. Edge Function ì§ì ‘ í…ŒìŠ¤íŠ¸ (ì„ íƒì‚¬í•­)
í„°ë¯¸ë„ì—ì„œ ë‹¤ìŒ ëª…ë ¹ì–´ ì‹¤í–‰ (ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì‹¤ì œ ì£¼ì†Œë¡œ ë³€ê²½):

```bash
curl -X POST \
  'https://dcovjxmrqomuuwcgiwie.supabase.co/functions/v1/send-task-email' \
  -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRjb3ZqeG1ycW9tdXV3Y2dpd2llIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NjAwNjMyNywiZXhwIjoyMDgxNTgyMzI3fQ.0nK3qmclkR2urRsAytgRthpdb-OwaX6rJLLiOIsQH1o' \
  -H 'Content-Type: application/json' \
  -d '{
    "eventType": "STATUS_CHANGED",
    "taskId": "test-task-id",
    "oldStatus": "ASSIGNED",
    "newStatus": "IN_PROGRESS",
    "assignerEmail": "your-email@example.com",
    "assigneeEmail": "your-email@example.com",
    "assignerName": "ì§€ì‹œì",
    "assigneeName": "ë‹´ë‹¹ì",
    "taskTitle": "í…ŒìŠ¤íŠ¸ Task",
    "projectTitle": "í…ŒìŠ¤íŠ¸ í”„ë¡œì íŠ¸",
    "recipients": ["assigner", "assignee"]
  }'
```

## ğŸ” ë¬¸ì œ í•´ê²° ì²´í¬ë¦¬ìŠ¤íŠ¸

ë‹¤ìŒ í•­ëª©ë“¤ì„ í™•ì¸í•˜ì„¸ìš”:

- [ ] Task ìƒì„± ì‹œ Postgres Logsì— `[EMAIL_TRIGGER]` ë©”ì‹œì§€ê°€ ë‚˜íƒ€ë‚˜ëŠ”ì§€
- [ ] Task ìƒíƒœ ë³€ê²½ ì‹œ Postgres Logsì— `[EMAIL_TRIGGER]` ë©”ì‹œì§€ê°€ ë‚˜íƒ€ë‚˜ëŠ”ì§€
- [ ] Edge Function ë¡œê·¸ì— í˜¸ì¶œ ê¸°ë¡ì´ ìˆëŠ”ì§€
- [ ] `email_logs` í…Œì´ë¸”ì— ë°œì†¡ ì‹œë„ ê¸°ë¡ì´ ìˆëŠ”ì§€
- [ ] ì‹¤ì œ ì´ë©”ì¼ì´ ìˆ˜ì‹ ë˜ëŠ”ì§€

## âš ï¸ ë¬¸ì œê°€ ì§€ì†ë  ê²½ìš°

### 1. íŠ¸ë¦¬ê±°ê°€ ì‹¤í–‰ë˜ì§€ ì•ŠëŠ” ê²½ìš°
- Postgres Logsì— `[EMAIL_TRIGGER]` ë©”ì‹œì§€ê°€ ì—†ìŒ
- **í•´ê²°**: íŠ¸ë¦¬ê±° í™œì„±í™” ìƒíƒœ í™•ì¸, íŠ¸ë¦¬ê±° ì¬ìƒì„±

### 2. Edge Functionì´ í˜¸ì¶œë˜ì§€ ì•ŠëŠ” ê²½ìš°
- Postgres Logsì—ëŠ” ìˆì§€ë§Œ Edge Function ë¡œê·¸ì—ëŠ” ì—†ìŒ
- **í•´ê²°**: `net.http_post` í˜¸ì¶œ í™•ì¸, ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ í™•ì¸

### 3. SMTP ì¸ì¦ ì‹¤íŒ¨
- Edge Function ë¡œê·¸ì— SMTP ì¸ì¦ ì˜¤ë¥˜
- **í•´ê²°**: Supabase Secretsì—ì„œ `SMTP_USER`, `SMTP_PASS` í™•ì¸

### 4. ì´ë©”ì¼ì´ ìŠ¤íŒ¸ í´ë”ë¡œ ì´ë™
- ì´ë©”ì¼ ë¡œê·¸ì—ëŠ” ì„±ê³µí–ˆì§€ë§Œ ìˆ˜ì‹ í•˜ì§€ ëª»í•¨
- **í•´ê²°**: ìŠ¤íŒ¸ í´ë” í™•ì¸, ë°œì‹ ì ì´ë©”ì¼ ì£¼ì†Œ í™•ì¸

## ğŸ“ ì°¸ê³  íŒŒì¼

- `supabase/migrations/20250101000028_fix_email_triggers_final.sql`: ìµœì¢… ìˆ˜ì • ë§ˆì´ê·¸ë ˆì´ì…˜
- `ì´ë©”ì¼_ì „ì†¡_ë¬¸ì œ_ì¢…í•©_ë¶„ì„.md`: ì „ì²´ ë¶„ì„ ë³´ê³ ì„œ
- `ì´ë©”ì¼_ë¬¸ì œ_í•´ê²°_ê°€ì´ë“œ.md`: ë‹¨ê³„ë³„ í•´ê²° ê°€ì´ë“œ

## âœ… ìˆ˜ì • ì™„ë£Œ í™•ì¸

ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ìˆ˜ì • ì‚¬í•­ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```sql
-- íŠ¸ë¦¬ê±° í•¨ìˆ˜ í™•ì¸
SELECT 
  proname AS function_name,
  CASE 
    WHEN prosrc LIKE '%dcovjxmrqomuuwcgiwie.supabase.co%' THEN 'í•˜ë“œì½”ë”©ë¨ âœ“'
    ELSE 'í™˜ê²½ ë³€ìˆ˜ ì‚¬ìš© âœ—'
  END AS url_config,
  CASE 
    WHEN prosrc LIKE '%RAISE NOTICE%EMAIL_TRIGGER%' THEN 'ë¡œê¹… ì¶”ê°€ë¨ âœ“'
    ELSE 'ë¡œê¹… ì—†ìŒ âœ—'
  END AS logging_status
FROM pg_proc
WHERE proname IN ('send_task_created_email', 'send_task_status_change_email');
```

ì˜ˆìƒ ê²°ê³¼:
- `url_config`: `í•˜ë“œì½”ë”©ë¨ âœ“`
- `logging_status`: `ë¡œê¹… ì¶”ê°€ë¨ âœ“`

---

**ìˆ˜ì • ì™„ë£Œì¼**: 2025-01-XX
**ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼**: `20250101000028_fix_email_triggers_final.sql`


